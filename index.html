<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Basic Map</title>

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>

  <!-- Our CSS -->
 <!-- <link rel="stylesheet" type="text/css" href="style.css">-->

  <!-- D3 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.5.0/d3.min.js"></script>

  <!-- Random Color -->
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/randomcolor/0.5.2/randomColor.min.js"></script>

  <style>
      body {
  padding: 0;
  margin: 0;
}

/* set map, body, and html to 100% of the screen size */
#map,
body,
html {
  height: 100%;
}
  </style>
</head>

<body>

        <body>
                <div class="container">
                        <div class="jumbotron text-center"  id = "jumbo" style="margin-top: 20px">
                                
                            <h1>UT Plant Collection</h1>
                                    
                        </div>
                </div> 
                <div class="row">
                  <div class="col-md-2">
                      <div class="well">
                          <h5>SELECT Plant Family:</h5>
                          <select id="selDataset" onchange="getData(this.value)"></select>
                      </div>
        
                  </div>
        
                  </div>       
        
        
        
          <!-- The div that holds our map -->
          <div id="map"></div>
        


 
  <!-- Our JS -->
  <script type="text/javascript">
  
  var myMap = L.map("map", {
  center:[32, -97.0059],
  zoom: 7
});

// Adding a tile layer (the background map image) to our map
// We use the addTo method to add objects to our map
L.tileLayer(
  "https://api.mapbox.com/styles/v1/mapbox/outdoors-v10/tiles/256/{z}/{x}/{y}?" +
    "access_token=pk.eyJ1IjoianN3eWVycyIsImEiOiJjamRoazc4dTkwem1mMnZucXVzbWM4cmUwIn0.ZmFC4Am6nFR2_e1Q8jg6Fg"
).addTo(myMap);

var baseMaps = {
        "Lightmap": myMap
    };

function getData(family) {
        // Use a request to grab the json data needed for the map and image div
        url = `/families/${family}` 
        d3.json(url, function(error, response) {
            if (error) return console.warn(error);
            console.log(response);
            updateMap(response);

      


        });
    };

var families = ['Apiaceae',
'Asteraceae',
'Boraginaceae',
'Brassicaceae',
'Chenopodiaceae',
'Cupressaceae',
'Cyperaceae',
'Euphorbiaceae',
'Fabaceae',
'Fagaceae',
'Grossulariaceae',
'Hydrangeaceae',
'Hydrophyllaceae',
'Juglandaceae',
'Juncaceae',
'Lamiaceae',
'Oleaceae',
'Pinaceae',
'Poaceae',
'Polygonaceae',
'Primulaceae',
'Rhamnaceae',
'Rosaceae',
'Salicaceae',
'Sarraceniaceae',
'Saxifragaceae',
'Scrophulariaceae',
'Solanaceae',
'Taxodiaceae',
'Zygophyllaceae']
  
// Build dropdown selections
var selector = document.getElementById('selDataset');
for (var i = 0; i < families.length;  i++) {
    var currentOption = document.createElement('option');
    currentOption.text = families[i];
    currentOption.value = families[i]
    selector.appendChild(currentOption);
};

function updateMap(newFamily) {
    var reducedFamily = [];
    for (var i = 0; i<newFamily.length; i ++) { 
        if (newFamily[i][2]) { 
        reducedFamily.push(newFamily[i])
        };
    };
    function Comparator(a, b) {
        if (a[1] < b[1]) return -1;
        if (a[1] > b[1]) return 1;
        return 0;
    };

    var sortedFamily = reducedFamily.sort(Comparator);
    
    var currentSpecies = sortedFamily[0][1];
    var speciesLayer = [];

    var overlayMaps = {};
    var currentSpeciesName = '';

    

   // Cycle through species
    var colorSeed = 1;
    for (i = 0; i < sortedFamily.length; i ++) {
      

        if (sortedFamily[i][1] == currentSpecies) {
            var circle = L.circleMarker([sortedFamily[i][2],sortedFamily[i][3]],
                {radius:8,
                  stroke:false,
                  fillOpacity:.5,
                  weight: 10,
                  color:randomColor({seed:colorSeed,
                                    luminosity: 'dark'})
                })
                  .bindPopup('<p><h1>' + sortedFamily[i][1] + '</h1></p>' +
                          '<table><tr>'+ "<strong>Date collected:   </strong>" + sortedFamily[i][5] + '</tr>' +
                          '<table><tr>'+ "<strong>County:   </strong>" + sortedFamily[i][8] + '</tr>' +
                          '<table><tr>'+ "<strong>Collector:   </strong>" + sortedFamily[i][7] + '</tr>' +
                          '<table><tr>'+ "<strong>Identifier:   </strong>" + sortedFamily[i][6] + '</tr>' +
                          '<table><tr>'+ "<strong>Habitat:   </strong>" + sortedFamily[i][4] + '</tr>' +
                          '</table>' +
                          '<img src='+ sortedFamily[i][10] + '  alt="No image available" height="150" width="100">' +
                          '<p><a href=' + sortedFamily[i][9] + ' target="_blank">Larger Image</a></p>');
            speciesLayer.push(circle);
            //console.log(sortedFamily[i][1],sortedFamily[i][2],sortedFamily[i][3]);
            //console.log(sortedFamily[i][10]);
        }
        else {
            colorSeed ++;
            currentSpeciesName=sortedFamily[i-1][1];
            currentSpecies = L.layerGroup(speciesLayer);
            overlayMaps[currentSpeciesName] = currentSpecies;
            var speciesLayer = [];
            var circle = L.circleMarker([sortedFamily[i][2],sortedFamily[i][3]],
                {radius:8,
                  stroke:false,
                  fillOpacity:.5,
                  weight: 10,
                  color:randomColor({seed:colorSeed,
                                    luminosity: 'dark'})
                })
                  .bindPopup('<p><h1>' + sortedFamily[i][1] + '</h1></p>' +
                  '<table><tr>'+ "<strong>Date collected:   </strong>" + sortedFamily[i][5] + '</tr>' +
                          '<table><tr>'+ "<strong>County:   </strong>" + sortedFamily[i][8] + '</tr>' +
                          '<table><tr>'+ "<strong>Collector:   </strong>" + sortedFamily[i][7] + '</tr>' +
                          '<table><tr>'+ "<strong>Identifier:   </strong>" + sortedFamily[i][6] + '</tr>' +
                          '<table><tr>'+ "<strong>Habitat:   </strong>" + sortedFamily[i][4] + '</tr>' +
                          '</table>'+
                          '<img src='+ sortedFamily[i][10] + '  alt="No image available" height="150" width="100">'+
                          '<p><a href=' + sortedFamily[i][9] + ' target="_blank">Larger Image</a></p>');
            speciesLayer.push(circle);
            currentSpecies = sortedFamily[i][1];
           // console.log('b');
           // console.log(overlayMaps);
        }; 
    };  
    
    var finalMap = L.control.layers(baseMaps,overlayMaps,{
  collapsed: false
});
    finalMap.addTo(myMap);
};


  </script>
</body>
</html>
